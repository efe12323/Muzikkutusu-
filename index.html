<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Müzik Kutusu</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#1DB954',
        dark: '#0f0f0f',
        card: '#191919'
      }
    }
  }
}
</script>
</head>

<body class="bg-dark text-white">

<!-- HEADER -->
<div class="w-full p-4 bg-black/60 backdrop-blur-md sticky top-0 z-50 flex justify-between items-center shadow-lg">
  <h1 class="text-2xl font-bold text-primary">Müzik Kutusu</h1>

  <div class="flex gap-3">
    <input id="search" oninput="renderMusics()" placeholder="Ara..."
      class="bg-neutral-800 px-4 py-2 rounded-xl outline-none w-56">

    <select id="filter" onchange="renderMusics()"
      class="bg-neutral-800 px-4 py-2 rounded-xl outline-none">
      <option value="all">Tümü</option>
      <option value="Rap">Rap</option>
      <option value="Chill">Chill</option>
      <option value="Rock">Rock</option>
      <option value="Anadolu Rock">Anadolu Rock</option>
      <option value="Electronic">Electronic</option>
      <option value="Lo-fi">Lo-fi</option>
      <option value="Jazz">Jazz</option>
    </select>
  </div>
</div>

<!-- GRID -->
<div id="musicList" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 p-6 pb-32"></div>

<!-- PLAYER -->
<div id="player"
  class="hidden fixed bottom-0 left-0 right-0 bg-black/90 backdrop-blur-lg border-t border-neutral-700 p-4 flex justify-between items-center">
  <div class="flex items-center gap-4">
    <img id="playerCover" class="w-14 h-14 rounded-md object-cover">
    <p id="playerTitle" class="font-semibold"></p>
  </div>
  <div class="flex items-center gap-5 text-2xl">
    <button onclick="prevMusic()">⏮</button>
    <button id="playPause" onclick="togglePlay()">▶️</button>
    <button onclick="nextMusic()">⏭</button>
    <a id="downloadBtn" download>⬇</a>
  </div>
</div>

<!-- ADMIN BUTTON -->
<button onclick="openAdminModal()"
class="fixed bottom-24 right-6 bg-primary text-black px-5 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition">
  Admin Panel
</button>

<!-- ADMIN MODAL -->
<div id="adminModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
  <div class="bg-card w-full max-w-2xl p-6 rounded-xl shadow-2xl overflow-y-auto max-h-[90vh]">

    <h2 class="text-2xl text-primary font-bold mb-4">Admin Panel</h2>

    <div id="adminLogin">
      <input id="adminPass" type="password" placeholder="Admin şifresi"
        class="w-full p-3 rounded bg-neutral-800 mb-4">
      <button onclick="checkAdmin()"
        class="w-full bg-primary py-2 text-black font-bold rounded">
        Giriş Yap
      </button>
    </div>

    <div id="adminPanel" class="hidden">
      <h3 class="text-lg mb-3">Yeni Müzik Ekle</h3>

      <input id="musicTitle" placeholder="Başlık" class="w-full p-2 mb-2 rounded bg-neutral-800">
      <input id="musicTags" placeholder="Etiketler (örn: Chill, Rap)" class="w-full p-2 mb-2 rounded bg-neutral-800">

      <p class="text-sm text-gray-400">Kapak Resmi</p>
      <input id="musicCover" type="file" accept="image/*" class="w-full mb-2">

      <p class="text-sm text-gray-400">Müzik Dosyası (mp3)</p>
      <input id="musicFile" type="file" accept="audio/*" class="w-full mb-4">

      <button onclick="uploadMusic()"
        class="w-full bg-primary text-black py-2 rounded font-bold">
        Müzik Yükle
      </button>

      <p id="status" class="text-center text-sm text-gray-400 mt-2"></p>

      <hr class="my-6 border-neutral-700">

      <h3 class="text-lg mb-4">Yüklenen Müzikler</h3>
      <div id="adminMusicList" class="space-y-4"></div>

      <button onclick="closeAdminModal()"
        class="w-full mt-6 bg-neutral-800 py-2 rounded">
        Kapat
      </button>
    </div>
  </div>
</div>

<script>
/* =================== SABİTLER =================== */
const ADMIN_PASS = "efe12345efe";
const CLOUD_NAME = "dq4iighak";
const UPLOAD_PRESET = "music_upload";
const SUPABASE_URL = "https://lzyfyxcpqmgemguyoxny.supabase.co";        // Burayı doldur
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6eWZ5eGNwcW1nZW1ndXlveG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTM5OTEsImV4cCI6MjA4MDU4OTk5MX0.a7e0-KU14yANxbhU95XFKmZGtuLIkTC7STJxG7mB4aA"; // Burayı doldur

/* =================== GLOBAL DEĞİŞKENLER =================== */
let musics = [];
let audio = new Audio();
let currentIndex = 0;
let db = null; // null olarak başlatıyoruz, hata almayız

/* =================== SUPABASE BAĞLANTISI =================== */
async function initSupabase() {
  if (!SUPABASE_URL.includes("BURAYA") && !SUPABASE_ANON_KEY.includes("BURAYA")) {
    db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    await loadMusics(); // bağlantı kurulduktan sonra müzikleri yükle
  } else {
    console.error("Supabase URL ve Anon Key girilmelidir!");
    alert("Supabase ayarları eksik!");
  }
}

/* Sayfa tamamen yüklendiğinde Supabase başlat */
window.addEventListener('DOMContentLoaded', initSupabase);

/* =================== CLOUDINARY UPLOAD =================== */
function uploadToCloudinary(file, type) {
  const url = `https://api.cloudinary.com/v1_1/\( {CLOUD_NAME}/ \){type}/upload`;
  const data = new FormData();
  data.append("file", file);
  data.append("upload_preset", UPLOAD_PRESET);
  return fetch(url, { method: "POST", body: data }).then(res => res.json());
}

/* =================== ADMIN MODAL =================== */
function openAdminModal() { document.getElementById("adminModal").classList.remove("hidden"); }
function closeAdminModal() { document.getElementById("adminModal").classList.add("hidden"); document.getElementById("adminPass").value = ""; }

/* =================== ADMIN LOGIN =================== */
function checkAdmin() {
  if (document.getElementById("adminPass").value === ADMIN_PASS) {
    document.getElementById("adminLogin").classList.add("hidden");
    document.getElementById("adminPanel").classList.remove("hidden");
    renderAdminList();
  } else {
    alert("Hatalı şifre!");
  }
}

/* =================== MÜZİKLERİ YÜKLE =================== */
async function loadMusics() {
  if (!db) {
    console.log("Supabase henüz hazır değil, tekrar deneniyor...");
    setTimeout(loadMusics, 500);
    return;
  }

  try {
    const { data, error } = await db.from("musics").select("*");
    if (error) throw error;
    musics = data || [];
    renderMusics();
    renderAdminList();
  } catch (err) {
    console.error("Müzikler yüklenirken hata:", err);
  }
}

/* =================== YENİ MÜZİK EKLE =================== */
async function uploadMusic() {
  if (!db) {
    alert("Veritabanı bağlantısı henüz kurulamadı, lütfen bekleyin...");
    return;
  }

  const title = document.getElementById("musicTitle").value.trim();
  const tags = document.getElementById("musicTags").value.trim();
  const cover = document.getElementById("musicCover").files[0];
  const file = document.getElementById("musicFile").files[0];

  if (!title || !tags || !cover || !file) {
    alert("Tüm alanları doldurunuz!");
    return;
  }

  document.getElementById("status").innerText = "Yükleniyor...";

  try {
    const coverRes = await uploadToCloudinary(cover, "image");
    const audioRes = await uploadToCloudinary(file, "video"); // Cloudinary mp3'leri video olarak kabul eder

    const { error } = await db.from("musics").insert([{
      title: title,
      tags: tags,
      cover_url: coverRes.secure_url,
      audio_url: audioRes.secure_url
    }]);

    if (error) throw error;

    // Formu temizle
    document.getElementById("musicTitle").value = "";
    document.getElementById("musicTags").value = "";
    document.getElementById("musicCover").value = "";
    document.getElementById("musicFile").value = "";

    await loadMusics();
    document.getElementById("status").innerText = "Müzik başarıyla eklendi!";
  } catch (err) {
    console.error(err);
    document.getElementById("status").innerText = "Hata oluştu!";
  }
}

/* =================== MÜZİK SİL =================== */
async function deleteMusic(index) {
  if (!db) return;
  if (!confirm("Bu müzik silinsin mi?")) return;

  try {
    const music = musics[index];
    await db.from("musics").delete().eq("id", music.id); // id ile silmek daha güvenli
    await loadMusics();
  } catch (err) {
    console.error(err);
  }
}

/* =================== RENDER =================== */
function renderMusics() {
  const list = document.getElementById("musicList");
  list.innerHTML = "";

  const search = document.getElementById("search").value.toLowerCase();
  const filter = document.getElementById("filter").value;

  musics
    .filter(m => 
      m.title.toLowerCase().includes(search) &&
      (filter === "all" || m.tags.toLowerCase().includes(filter.toLowerCase()))
    )
    .forEach((m, i) => {
      const div = document.createElement("div");
      div.onclick = () => playMusic(i);
      div.className = "bg-card p-3 rounded-xl shadow-lg hover:scale-105 transition cursor-pointer";
      div.innerHTML = `
        <img src="\( {m.cover_url}" class="rounded-lg mb-2 h-48 w-full object-cover" alt=" \){m.title}">
        <p class="font-semibold truncate">${m.title}</p>
        <p class="text-sm text-gray-400 truncate">${m.tags}</p>
      `;
      list.appendChild(div);
    });
}

function renderAdminList() {
  const container = document.getElementById("adminMusicList");
  if (!container) return;
  container.innerHTML = "";

  musics.forEach((m, i) => {
    const div = document.createElement("div");
    div.className = "bg-neutral-800 p-3 rounded-lg flex items-center justify-between";
    div.innerHTML = `
      <div class="flex items-center gap-4">
        <img src="${m.cover_url}" class="h-20 rounded">
        <div>
          <p class="font-bold">${m.title}</p>
          <p class="text-sm text-gray-400">${m.tags}</p>
        </div>
      </div>
      <button onclick="deleteMusic(${i})" class="bg-red-600 px-4 py-2 rounded">Sil</button>
    `;
    container.appendChild(div);
  });
}

/* =================== PLAYER =================== */
function playMusic(index) {
  currentIndex = index;
  const m = musics[index];

  document.getElementById("player").classList.remove("hidden");
  document.getElementById("playerCover").src = m.cover_url;
  document.getElementById("playerTitle").innerText = m.title;
  document.getElementById("downloadBtn").href = m.audio_url;

  audio.src = m.audio_url;
  audio.play();
  document.getElementById("playPause").innerText = "⏸";
}

function togglePlay() {
  if (audio.paused) {
    audio.play();
    document.getElementById("playPause").innerText = "⏸";
  } else {
    audio.pause();
    document.getElementById("playPause").innerText = "▶️";
  }
}

function nextMusic() {
  if (currentIndex < musics.length - 1) playMusic(currentIndex + 1);
  else playMusic(0); // döngü
}

function prevMusic() {
  if (currentIndex > 0) playMusic(currentIndex - 1);
  else playMusic(musics.length - 1); // döngü
}
</script>
</body>
</html>
