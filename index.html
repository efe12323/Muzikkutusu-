<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√ºzik Kutusu</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body class="bg-[#121212] text-white">

<!-- HEADER -->
<header class="flex justify-between items-center p-5 bg-black sticky top-0 z-50">
  <h1 class="text-2xl font-bold text-green-500">üéµ M√ºzik Kutusu</h1>
  <button onclick="openAdminLogin()" class="text-sm px-4 py-2 border border-green-500 rounded-full hover:bg-green-500 hover:text-black">
    Admin
  </button>
</header>

<!-- SEARCH & FILTER -->
<div class="p-5 flex flex-col md:flex-row gap-4">
  <input id="searchInput" onkeyup="fetchMusics()" type="text" placeholder="M√ºzik ara..."
    class="bg-[#1f1f1f] p-3 px-5 rounded-full w-full outline-none" />

  <select id="filterSelect" onchange="fetchMusics()"
    class="bg-[#1f1f1f] p-3 px-5 rounded-full outline-none">
    <option value="">T√ºm√º</option>
    <option value="Rap">Rap</option>
    <option value="Anadolu">Anadolu Rock</option>
    <option value="Lo-fi">Lo-Fi</option>
    <option value="Chill">Chill</option>
    <option value="Pop">Pop</option>
    <option value="Rock">Rock</option>
  </select>
</div>

<!-- MUSIC LIST -->
<div id="musicList" class="p-6 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>

<!-- PLAYER -->
<div id="player" class="hidden fixed bottom-0 w-full bg-black border-t border-gray-800 flex items-center gap-4 p-4">
  <img id="playerCover" class="w-16 h-16 rounded-lg object-cover" />
  <div class="flex-1">
    <p id="playerTitle" class="font-bold"></p>
  </div>
  <button onclick="prevMusic()">‚èÆ</button>
  <button onclick="togglePlay()">‚èØ</button>
  <button onclick="nextMusic()">‚è≠</button>
  <a id="downloadBtn" class="px-3 py-2 border rounded-lg" download>‚¨áÔ∏è</a>
</div>

<audio id="audio"></audio>

<!-- ADMIN LOGIN MODAL -->
<div id="adminLoginModal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center">
  <div class="bg-[#181818] p-8 rounded-xl w-80">
    <h3 class="text-xl mb-4">Admin Giri≈üi</h3>
    <input type="password" id="adminPassword" placeholder="≈ûifre"
      class="w-full p-3 rounded bg-[#222] outline-none mb-4">
    <button onclick="checkPassword()" class="w-full bg-green-500 p-3 rounded text-black font-bold">
      Giri≈ü
    </button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="hidden bg-black p-8 mt-10 rounded-xl mx-5">
  <h2 class="text-2xl mb-6 text-green-500">üéß Admin Paneli</h2>

  <div class="grid md:grid-cols-2 gap-6">
    <input id="titleInput" type="text" placeholder="M√ºzik Ba≈ülƒ±ƒüƒ±"
      class="p-3 bg-[#222] rounded">
    <input id="tagsInput" type="text" placeholder="Etiketler (√∂r: Rap, Chill)"
      class="p-3 bg-[#222] rounded">
    <input id="coverInput" type="file" accept="image/*"
      class="p-3 bg-[#222] rounded">
    <input id="fileInput" type="file" accept="audio/*"
      class="p-3 bg-[#222] rounded">
  </div>

  <button onclick="uploadMusic()"
    class="mt-6 bg-green-500 text-black font-bold px-6 py-3 rounded-full">
    M√ºzik Y√ºkle
  </button>

  <p id="adminMessage" class="mt-4"></p>

  <h3 class="text-xl mt-10 mb-4">Y√ºkl√º M√ºzikler</h3>
  <div id="adminMusicList" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>
</div>


<script>
const { createClient } = supabase
const supabaseClient = createClient(
  "https://jzidtvylnrolmmlaegyr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6aWR0dnlsbnJvbG1tbGFlZ3lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMDQ4ODgsImV4cCI6MjA4MDU4MDg4OH0.S61VHALTStNxq2RY4B2GhrAuELTtgycsTrTw5cH04EA"
)

let musics = []
let currentMusicIndex = 0

// FETCH MUSIC
async function fetchMusics() {
  const search = document.getElementById("searchInput").value.toLowerCase()
  const filter = document.getElementById("filterSelect").value

  let { data } = await supabaseClient.from("musics").select("*")

  musics = data.filter(m =>
    m.title.toLowerCase().includes(search) &&
    (filter === "" || m.tags.includes(filter))
  )

  renderMusics()
  renderAdminMusics()
}

function renderMusics() {
  const container = document.getElementById("musicList")
  container.innerHTML = ""

  musics.forEach((m, i) => {
    const div = document.createElement("div")
    div.className = "bg-[#181818] p-4 rounded-xl hover:bg-[#222] cursor-pointer"
    div.innerHTML = `
      <img src="${m.cover_url}" class="w-full aspect-square object-cover rounded-lg mb-3">
      <h4 class="font-bold">${m.title}</h4>
      <p class="text-sm text-gray-400">${m.tags}</p>
    `
    div.onclick = () => playMusic(i)
    container.appendChild(div)
  })
}

// PLAY
function playMusic(index) {
  currentMusicIndex = index
  const music = musics[index]

  document.getElementById("player").classList.remove("hidden")
  document.getElementById("playerCover").src = music.cover_url
  document.getElementById("playerTitle").textContent = music.title
  document.getElementById("audio").src = music.audio_url
  document.getElementById("downloadBtn").href = music.audio_url

  document.getElementById("audio").play()
}

function togglePlay() {
  const audio = document.getElementById("audio")
  audio.paused ? audio.play() : audio.pause()
}

function nextMusic() {
  if (currentMusicIndex < musics.length - 1) {
    playMusic(currentMusicIndex + 1)
  }
}

function prevMusic() {
  if (currentMusicIndex > 0) {
    playMusic(currentMusicIndex - 1)
  }
}


// ADMIN
function openAdminLogin() {
  document.getElementById("adminLoginModal").classList.remove("hidden")
}

function checkPassword() {
  const pass = document.getElementById("adminPassword").value

  if (pass === "efe12345efe") {
    document.getElementById("adminLoginModal").classList.add("hidden")
    document.getElementById("adminPanel").classList.remove("hidden")
    fetchMusics()
  } else {
    alert("≈ûifre yanlƒ±≈ü")
  }
}

// UPLOAD
async function uploadMusic() {
  const title = titleInput.value
  const tags = tagsInput.value
  const file = fileInput.files[0]
  const cover = coverInput.files[0]

  if (!title || !tags || !file || !cover) {
    adminMessage.textContent = "‚ö†Ô∏è T√ºm alanlar gerekli"
    return
  }

  const audioPath = Date.now() + "_" + file.name
  const coverPath = Date.now() + "_" + cover.name

  await supabaseClient.storage.from("music").upload(audioPath, file)
  await supabaseClient.storage.from("music").upload(coverPath, cover)

  const audio_url = supabaseClient.storage.from("music").getPublicUrl(audioPath).data.publicUrl
  const cover_url = supabaseClient.storage.from("music").getPublicUrl(coverPath).data.publicUrl

  await supabaseClient.from("musics").insert([
    { title, tags, audio_url, cover_url }
  ])

  adminMessage.textContent = "‚úÖ M√ºzik ba≈üarƒ±yla eklendi"
  titleInput.value = ""
  tagsInput.value = ""
  fileInput.value = ""
  coverInput.value = ""

  fetchMusics()
}

// DELETE
async function deleteMusic(id, url1, url2) {
  const file1 = url1.split("/").pop()
  const file2 = url2.split("/").pop()

  await supabaseClient.storage.from("music").remove([file1, file2])
  await supabaseClient.from("musics").delete().eq("id", id)

  fetchMusics()
}

function renderAdminMusics() {
  const box = document.getElementById("adminMusicList")
  box.innerHTML = ""

  musics.forEach(m => {
    const div = document.createElement("div")
    div.className = "bg-[#181818] p-3 rounded-lg"
    div.innerHTML = `
      <img src="${m.cover_url}" class="w-full h-32 object-cover rounded">
      <p class="mt-2">${m.title}</p>
      <button class="mt-2 bg-red-600 w-full p-2 rounded"
       onclick="deleteMusic('${m.id}','${m.audio_url}','${m.cover_url}')">
          Sil
      </button>
    `
    box.appendChild(div)
  })
}

fetchMusics()

</script>

</body>
</html>
